<!-- ============================= -->
<!-- CONNECTION FORM -->
<!-- ============================= -->
<form
  [formGroup]="formConnection"
  (ngSubmit)="onSubmit()"
  class="w-full"
  *ngIf="connection != null"
>
  <span class="text-xl dark:text-surface-400 block"
    >Connection: {{ connection.label }}</span
  >
  <p-divider class="mb-8"></p-divider>

  <!-- LABEL -->
  <p-floatlabel variant="on" class="mt-8 mb-4">
    <input
      id="label"
      type="text"
      pInputText
      size="small"
      formControlName="label"
      autocomplete="off"
      aria-describedby="label-help"
      class="w-full"
    />
    <label for="label">Label</label>
  </p-floatlabel>

  <!-- WEIGHT -->
  <p-floatlabel variant="on" class="mb-4">
    <p-inputnumber
      id="weight"
      inputId="minmax-buttons"
      mode="decimal"
      [showButtons]="true"
      [min]="0.0"
      [max]="maxWeight"
      [step]="0.1"
      [minFractionDigits]="1"
      [maxFractionDigits]="1"
      formControlName="weight"
      class="w-full"
    />
    <label for="weight">Weight</label>
  </p-floatlabel>

  <!-- PAYLOAD CONNECTION -->
  <div formGroupName="payload">
    <!-- Available endpoints -->
    <div class="mb-4 flex items-start">
      <span class="text-sm font-semibold">Endpoints on </span>
      <span class="text-sm font-semibold pl-2">{{connection.targetNode?.label}}</span>
    </div>
    <p-floatlabel class="w-full mb-4" variant="on">
      <p-select
        [options]="availableEndpoints"
        [showClear]="true"
        optionLabel="path"
        [checkmark]="true"
        placeholder="Select endpoint"
        (onChange)="selectConnectionEndpoint($event)"
        formControlName="endpoint"
        class="w-full"
      />
    </p-floatlabel>

    <!-- API CALL -->
    <fieldset
      formGroupName="apiCall"
      *ngIf="showApiCall"
      legend="API Call"
      class="mb-4 p-3 border p-3 rounded"
    >
      <!-- PATH -->
      <p-floatlabel variant="on" class="mb-4">
        <input
          id="path"
          type="text"
          pInputText
          size="small"
          formControlName="path"
          optionLabel=""
          optionValue=""
          [readonly]="true"
        />
        <label for="path">Path</label>
      </p-floatlabel>

      <!-- METHOD -->
      <div class="mb-4 flex justify-between items-center">
        <span class="text-sm font-semibold">Method</span>
      </div>
      <p-floatlabel variant="on" class="mb-4">
        <p-selectButton
          class="selectbutton-small"
          [options]="httpMethods"
          formControlName="method"
          [style.pointer-events]="readonlyMethod ? 'none' : 'auto'"
          [style.opacity]="readonlyMethod ? 0.6 : 1"
        ></p-selectButton>
      </p-floatlabel>

      <!-- PARAMETER VALUES -->
      <div formArrayName="parameterValues" class="mb-2">
        <div class="mb-4 flex justify-between items-center">
          <span class="text-sm font-semibold">Parameters</span>
        </div>

        <!-- HEADER -->
        <div class="flex gap-2 mb-2 text-xs font-semibold text-gray-500">
          <div class="w-2/5">Name</div>
          <div class="w-2/5">Value</div>
          <div class="w-8"></div>
          <!-- spazio per icona remove -->
        </div>

        <div
          *ngFor="let param of apiCallParameters.controls; let i = index"
          [formGroupName]="i"
          class="flex gap-2 mb-2 items-center"
        >
          <div class="field param-field w-2/5">
            <input
              type="text"
              pInputText
              [readonly]="param.get('system')?.value"
              [ngClass]="{
                'bg-gray-200 text-gray-500 border-gray-300 opacity-70 cursor-not-allowed':
                  param.get('system')?.value,
                'dark:bg-gray-700 dark:text-gray-400 dark:border-gray-600 dark:opacity-70':
                  param.get('system')?.value,
              }"
              placeholder="{{ param.get('name')?.value }} {{
                param.get('value')?.errors?.['required'] ? ' *' : ''
              }}"
              formControlName="name"
              class="w-full"
            />
          </div>

          <div class="field param-field w-2/5">
            <input
              type="text"
              pInputText
              placeholder="Value"
              formControlName="value"
              class="w-full"
            />
          </div>

          <!-- btn remove -->
          <p-button 
              class="w-8 "
              link="true"
              icon="pi pi-minus"
              (click)="removeApiCallParameter(i)" />
        </div>

        <p-button
          label="Add parameter"
          link="true"
          (click)="addApiCallParameter()"
        />
      </div>
    </fieldset>
  </div>

  <div class="flex justify-end">
    <button
      pButton
      type="submit"
      label="Apply"
      icon="pi pi-check"
      size="small"
      [disabled]="formConnection.invalid || formConnection.untouched"
    ></button>
  </div>

</form>

<!-- ============================= -->
<!-- NODE FORM -->
<!-- ============================= -->
<form
  [formGroup]="formNode"
  (ngSubmit)="onSubmit()"
  class="w-full"
  *ngIf="node != null"
>
  <span class="text-xl font-semibold block mb-3">Node: {{ node.label }}</span>
  <p-divider class="mb-8"></p-divider>

  <!-- LABEL -->
  <p-floatlabel variant="on" class="mb-4">
    <input
      id="label"
      class="w-full"
      type="text"
      pInputText
      size="small"
      formControlName="label"
    />
    <label for="label">Label</label>
  </p-floatlabel>

  <!-- WEIGHT 
  <p-floatlabel variant="on" class="mb-4">
    <p-inputnumber
      id="weight"
      inputId="minmax-buttons"
      mode="decimal"
      [showButtons]="true"
      [min]="0"
      [max]="1"
      [step]="0.1"
      [minFractionDigits]="1"
      [maxFractionDigits]="1"
      formControlName="weight"
      class="w-full"
    />
    <label for="weight">Weight</label>
  </p-floatlabel>-->

  <!-- PAYLOAD NODE -->
  <div formGroupName="payload">
    <p-floatlabel variant="on">
      <label for="initiator" class="pl-4"> initiator</label> 
      <p-checkbox
        formControlName="initiator"
        binary="true"
        pTooltip="Is initiator node (starting point of the workflow)"
        tooltipPosition="top"
        id="initiator"
      ></p-checkbox> 
    </p-floatlabel>

    <!-- LANGUAGE -->
    <p-floatlabel class="w-full mt-4 mb-4" variant="on">
      <p-select
        id="language"
        [options]="languages"
        [checkmark]="true"
        [showClear]="true"
        placeholder="Select language"
        formControlName="language"
        class="w-full"
      />
      <label for="language">Language</label>
    </p-floatlabel>

    <!-- BASEPATH -->
    <p-floatlabel variant="on" class="mb-4">
      <input
        id="basepath"
        class="w-full"
        type="text"
        pInputText
        size="small"
        formControlName="basePath"
      />
      <label for="basepath">BasePath</label>
      <small
        *ngIf="
          formNode.get('payload.basePath')?.invalid &&
          formNode.get('payload.basePath')?.touched
        "
        class="p-error"
      >
        Format must be /path/path (only letters, numbers, -, _)
      </small>
    </p-floatlabel>

    <!-- DESCRIPTION -->
    <p-floatlabel variant="on" class="mb-4">
      <textarea
        pTextarea
        id="description"
        class="w-full"
        [autoResize]="true"
        rows="3"
        maxlength="100"
        cols="30"
        formControlName="description"
      ></textarea>
      <label for="description">Description</label>
    </p-floatlabel>

    <!-- ENDPOINTS -->
    <div formArrayName="endpoints">
      <div class="mb-4 flex justify-between items-center">
        <span class="text-base font-semibold">Endpoints</span>
        <button
          pButton
          type="button"
          icon="pi pi-plus"
          label="Add Endpoint"
          size="small"
          class="p-button-sm"
          (click)="addEndpoint()"
        ></button>
      </div>
      <div
        *ngFor="let endpoint of endpoints.controls; let ei = index"
        [formGroupName]="ei"
        class="mb-4 border p-3 rounded relative"
      >
        <!-- Pulsante rimuovi endpoint -->
        <div class="mb-4 flex justify-between items-center">
          <span class="text-base font-semibold">Endpoint {{ ei }}</span>
          <p-button
            icon="pi pi-minus"
            label="remove endpoint"
            link="true"
            (click)="removeEndpoint(ei)"
          ></p-button>
        </div>

        <!-- PATH -->
        <p-floatlabel variant="on" class="mb-4">
          <input
            type="text"
            pInputText
            formControlName="path"
            placeholder="/endpoint"
            class="w-full"
          />
          <label>Path</label>
        </p-floatlabel>

        <!-- METHOD -->
        <p-floatlabel variant="on" class="mb-4">
          <p-selectButton
            [options]="httpMethods"
            formControlName="method"
            class="selectbutton-small"
          ></p-selectButton>
        </p-floatlabel>

        <!-- PARAMETERS -->
        <div formArrayName="parameters" class="mb-2">
          <div class="mb-4 flex justify-between items-center">
            <span class="text-sm font-semibold">Parameters</span>
          </div>

          <!-- HEADER -->
          <div class="flex gap-2 mb-2 text-xs font-semibold text-gray-500">
            <div class="w-2/5">Name</div>
            <div class="w-2/5">Type</div>
            <div class="w-1/5 text-center">Required</div>
            <div class="w-8"></div>
            <!-- spazio per icona remove -->
          </div>

          <!-- PARAMETER ROWS -->
          <div
            *ngFor="
              let param of endpointsParameters(ei).controls;
              let pi = index
            "
            [formGroupName]="pi"
            class="flex gap-2 mb-2 items-center"
          >
            <div class="field param-field w-2/5">
              <input
                type="text"
                pInputText
                placeholder="Name"
                size="small"
                formControlName="name"
                class="w-full"
              />
            </div>

            <div class="field param-field w-2/5">
              <p-select
                [options]="parameterTypes"
                [checkmark]="true"
                [showClear]="true"
                placeholder="Select type"
                formControlName="type"
                class="w-full"
              ></p-select>
            </div>

            <div class="w-1/5 flex justify-center">
              <p-checkbox
                formControlName="required"
                binary="true"
                pTooltip="Parameter required"
                tooltipPosition="top"
              ></p-checkbox>
            </div>

            <!-- btn remove -->
            <p-button 
              class="w-8 "
              link="true"
              icon="pi pi-minus"
              (click)="removeParameter(ei, pi)" />
          </div>

          <p-button
            label="add parameter"
            link="true"
            (click)="addParameter(ei)"
          />
        </div>

        <!-- RESPONSES -->
        <div formArrayName="responses">
          <div class="mb-4 flex justify-between items-center">
            <span class="text-sm font-semibold">Responses</span>
          </div>

          <!-- HEADER -->
          <div class="flex gap-2 mb-2 text-xs font-semibold text-gray-500">
            <div class="w-1/5 min-w-16">
              Status
            </div>
            <div class="w-2/5">Description</div>
            <div class="w-2/5">Type</div>
            <div class="w-8"></div>
          </div>

          <div
            *ngFor="let resp of endpointsResponses(ei).controls; let ri = index"
            [formGroupName]="ri"
            class="flex gap-2 mb-2"
          >
            <div class="field param-field w-1/5 min-w-16">
              <input
                type="number"
                pInputText
                placeholder="Status"
                formControlName="status"
                class="w-full"
              />
            </div>

            <div class="field param-field w-2/5">
              <input
                type="text"
                pInputText
                formControlName="description"
                class="w-full"
              />
            </div>

            <div class="field param-field w-2/5">
              <p-select
                [options]="['application/json', 'application/text', 'binary']"
                formControlName="type"
                class="w-full"
              ></p-select>
            </div>
            <!-- btn remove -->
            <p-button 
              class="w-8 "
              link="true"
              icon="pi pi-minus"
              (click)="removeResponse(ei, ri)"
            />
          </div>

          <p-button
            label="add response"
            link="true"
            (click)="addResponse(ei)"
          />
        </div>
        <button
            pButton
            label="Code"
            icon="pi pi-check"
            size="small"
            [disabled]="formNode.get('endpoints')?.value.length === 0"
            (click)="openCodeEditorDialog(ei)"
        ></button>
      </div>
    </div>
  </div>

  <div class="flex justify-end mt-4">
    <button
      pButton
      type="submit"
      label="Apply"
      icon="pi pi-check"
      size="small"
      [disabled]="formNode.invalid || formNode.untouched"
    ></button>
  </div>


  <editor-code-dialog #codeEditorDialog></editor-code-dialog>

</form>
